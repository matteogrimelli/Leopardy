<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Crea - Leopardy</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
</head>
<body class="text-white text-center">
    <a href="index.html" id="backToHomeButton" class="btn btn-warning">Torna alla Home</a>
    <h1 class="display-3">Crea il tuo Tabellone</h1>
    <div class="mb-4">
      <input type="text" class="form-control" id="boardName" placeholder="Inserisci il nome del tabellone">
    </div>
    <div class="card bg-light text-dark mt-4 p-4 shadow-lg rounded">
      <div class="mb-3">
        <button class="btn btn-success me-2" id="addColumn">Aggiungi Colonna</button>
        <button class="btn btn-success" id="addRow">Aggiungi Riga</button>
      </div>
      <!-- Tabellone iniziale 2x2: l'header ha due categorie e il corpo due righe -->
      <table class="table table-bordered board-table" id="board">
        <thead>
          <tr>
            <th style="width: 150px;"></th>
            <th contenteditable="true">Categoria 1</th>
            <th contenteditable="true">Categoria 2</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>
              <button class="btn btn-info btn-points" contenteditable="true">Punti 100</button>
            </td>
            <td>
              <button class="btn btn-primary btn-question"></button>
            </td>
            <td>
              <button class="btn btn-primary btn-question"></button>
            </td>
          </tr>
          <tr>
            <td>
              <button class="btn btn-info btn-points" contenteditable="true">Punti 200</button>
            </td>
            <td>
              <button class="btn btn-primary btn-question"></button>
            </td>
            <td>
              <button class="btn btn-primary btn-question"></button>
            </td>
          </tr>
        </tbody>
      </table>
      <button class="btn btn-warning mt-3" id="saveBoard">Salva Tabellone</button>
    </div>
  <!-- Modal per la creazione di domande/risposte -->
  <div class="modal" tabindex="-1" id="questionModal">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <!-- Il titolo verrà aggiornato dinamicamente per mostrare Categoria e Punti -->
          <h5 id="modalTitle" class="modal-title">Crea Domanda</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <!-- Sezione per la domanda -->
          <div class="mb-3">
            <label class="form-label fw-bold">Testo della Domanda</label>
            <!-- Toolbar per l'editor della domanda -->
            <div id="toolbar-question">
              <span class="ql-formats">
                <button class="ql-bold"></button>
                <button class="ql-italic"></button>
                <button class="ql-underline"></button>
              </span>
              <span class="ql-formats">
                <button class="ql-list" value="ordered"></button>
                <button class="ql-list" value="bullet"></button>
              </span>
              <span class="ql-formats">
                <select class="ql-color"></select>
                <select class="ql-background"></select>
              </span>
              <span class="ql-formats">
                <button class="ql-image"></button>
              </span>
            </div>
            <div id="questionEditor" class="editor-container"></div>
          </div>
          <!-- Sezione per la risposta -->
          <div class="mb-3">
            <label class="form-label fw-bold">Testo della Risposta</label>
            <!-- Toolbar per l'editor della risposta -->
            <div id="toolbar-answer">
              <span class="ql-formats">
                <button class="ql-bold"></button>
                <button class="ql-italic"></button>
                <button class="ql-underline"></button>
              </span>
              <span class="ql-formats">
                <button class="ql-list" value="ordered"></button>
                <button class="ql-list" value="bullet"></button>
              </span>
              <span class="ql-formats">
                <select class="ql-color"></select>
                <select class="ql-background"></select>
              </span>
            </div>
            <div id="answerEditor" class="editor-container"></div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Chiudi</button>
          <button type="button" class="btn btn-primary" id="saveQuestion">Salva Domanda</button>
        </div>
      </div>
    </div>
  </div>
  <!-- Bootstrap JS Bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <!-- Quill Editor JS -->
  <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
  <script>
    // Inizializzazione degli editor Quill con placeholder
    const quillQuestion = new Quill('#questionEditor', {
      modules: { toolbar: '#toolbar-question' },
      placeholder: 'Scrivi qui la domanda...',
      theme: 'snow'
    });
    /////////////////////////
    const quillAnswer = new Quill('#answerEditor', {
      modules: { toolbar: '#toolbar-answer' },
      placeholder: 'Scrivi qui la risposta...',
      theme: 'snow'
    });
    /////////////////////////
    const addColumnBtn = document.getElementById('addColumn');
    const addRowBtn = document.getElementById('addRow');
    const boardTable = document.getElementById('board');
    const boardTHead = boardTable.querySelector('thead tr');
    const boardTBody = boardTable.querySelector('tbody');
    const questionModal = new bootstrap.Modal(document.getElementById('questionModal'));
    const saveQuestionBtn = document.getElementById('saveQuestion');
    let currentQuestionButton = null; // Bottone della cella attualmente cliccata
    /////////////////////////
    // Funzione per associare l'evento di apertura del modal ai bottoni delle domande
    function attachQuestionEvent(button) {
        button.addEventListener('click', (event) => {
        if (button.classList.contains('btn-points')) return;
        currentQuestionButton = button;
        // Recupera la cella e l'indice di colonna
        const cell = button.parentElement;
        const cellIndex = cell.cellIndex;
        const row = cell.parentElement;
        // Ottieni il nome della categoria dalla riga header
        const categoryName = boardTHead.children[cellIndex].textContent.trim();
        const points = row.cells[0].querySelector('button').textContent.trim();
        // Aggiorna il titolo del modal
        document.getElementById('modalTitle').textContent = `Domanda - ${categoryName} - ${points}`;
        // Recupera i dati della domanda e della risposta salvati precedentemente
        const savedQuestion = button.getAttribute('data-question') || '';
        const savedAnswer = button.getAttribute('data-answer') || '';
        // Carica i dati salvati negli editor
        quillQuestion.root.innerHTML = savedQuestion;
        quillAnswer.root.innerHTML = savedAnswer;
        // Mostra il modal
        questionModal.show();
    });
    }
    /////////////////////////
    // Funzione per aprire la finestra modale con il contenuto della domanda e risposta
    function openQuestionModal(button) {
    // Ottieni i contenuti salvati dal bottone (contenuti preesistenti)
    const questionContent = button.getAttribute('data-question') || '';
    const answerContent = button.getAttribute('data-answer') || '';
    // Setta il titolo del modal con la categoria e il punteggio
    const category = button.closest('td').dataset.category; // Supponiamo che la categoria sia nel data-category dell'elemento
    const points = button.closest('tr').querySelector('td').innerText; // Supponiamo che i punti siano nella cella della riga
    const modalTitle = document.getElementById('modalTitle');
    modalTitle.innerHTML = `Categoria: ${category} - Punti: ${points}`;
    // Carica i contenuti salvati nei rispettivi editor di Quill
    quillQuestion.root.innerHTML = questionContent;
    quillAnswer.root.innerHTML = answerContent;
    // Apre il modal
    questionModal.show();
    }
    /////////////////////////
    // Aggiungi l'evento per ogni bottone per aprire il modal
    Array.from(document.querySelectorAll('.btn-question')).forEach(button => {
    button.addEventListener('click', () => openQuestionModal(button));
    });
    /////////////////////////
    // Salvataggio della domanda e risposta
    saveQuestionBtn.addEventListener('click', () => {
    const questionContent = quillQuestion.root.innerHTML;
    const answerContent = quillAnswer.root.innerHTML;
    // Se sia la domanda che la risposta sono vuote, non fare nulla
    if (!questionContent && !answerContent) return;
    // Aggiorna il bottone con il testo appropriato
    const buttonText = questionContent && answerContent
        ? 'Domanda e Risposta'
        : questionContent
        ? 'Solo Domanda'
        : 'Solo Risposta';
    // Salva i contenuti nel bottone
    currentQuestionButton.setAttribute('data-question', questionContent);
    currentQuestionButton.setAttribute('data-answer', answerContent);
    // Aggiorna il testo del bottone con il nuovo stato
    currentQuestionButton.textContent = buttonText;
    // Chiudi il modal
    questionModal.hide();
    });
    /////////////////////////
    // Massimo numero di righe e colonne
    const maxRows = 5;
    const maxColumns = 5;
    /////////////////////////
    // Funzione per aggiungere una colonna (categoria)
    addColumnBtn.addEventListener('click', () => {
    const currentColumns = boardTHead.children.length - 1; // Sottrai 1 per la prima cella vuota
    if (currentColumns >= maxColumns) {
        alert('Non puoi aggiungere più di 5 colonne!');
        return;
    }
    /////////////////////////
    const newColIndex = currentColumns + 1;
    const newHeaderCell = document.createElement('th');
    newHeaderCell.contentEditable = true;
    newHeaderCell.innerText = 'Categoria ' + newColIndex;
    boardTHead.appendChild(newHeaderCell);
    /////////////////////////
    // Aggiungi una cella per ogni riga nel tbody
    Array.from(boardTBody.rows).forEach((row) => {
            const newCell = row.insertCell(-1);
            newCell.innerHTML = `<button class="btn btn-primary btn-question"></button>`;
            attachQuestionEvent(newCell.querySelector('button'));
        });
    });
    /////////////////////////
    // Funzione per aggiungere una riga (punti)
    addRowBtn.addEventListener('click', () => {
        const currentRows = boardTBody.rows.length;
        if (currentRows >= maxRows) {
            alert('Non puoi aggiungere più di 5 righe!');
            return;
        }
        const row = boardTBody.insertRow();
        const pointsCell = row.insertCell();
        const pointsButton = document.createElement('button');
        pointsButton.classList.add('btn', 'btn-info', 'btn-points');
        pointsButton.contentEditable = true;
        pointsButton.innerText = `Punti ${boardTBody.rows.length * 100}`; // Punti 100, 200, 300...
        pointsCell.appendChild(pointsButton);

        // Aggiungi una cella per ogni colonna
        Array.from(boardTHead.children).slice(1).forEach(() => {
            const newCell = row.insertCell();
            newCell.innerHTML = `<button class="btn btn-primary btn-question"></button>`;
            attachQuestionEvent(newCell.querySelector('button'));
        });
    });
    /////////////////////////
    // Funzione per salvare il tabellone come file JSON
    /*
    const saveBoardAsJSON = () => {
    const boardName = document.getElementById('boardName').value || 'Tabellone Senza Nome';
    const table = document.getElementById('board');
    const headers = Array.from(table.querySelectorAll('thead th'))
        .slice(1) // Salta la prima colonna vuota
        .map(header => header.innerText);
    const rows = Array.from(table.querySelectorAll('tbody tr')).map(row => {
        return Array.from(row.children)
        .slice(1) // Salta la prima cella con i punti
        .map(cell => {
            const button = cell.querySelector('button');
            return button
            ? {
                text: button.innerText, // Testo del bottone
                question: button.getAttribute('data-question') || '', // Testo della domanda
                answer: button.getAttribute('data-answer') || '' // Testo della risposta
                }
            : {};
        });
    });
    const board = {
        name: boardName,
        categories: headers,
        rows: rows
    };
    const boardJSON = JSON.stringify(board, null, 2);
    const blob = new Blob([boardJSON], { type: 'application/json' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `${boardName}.json`;
    link.click();
    };
    */
    function salvaTabellone() {
      const boardName = document.getElementById("boardName").value || "Tabellone";
      const categories = Array.from(document.querySelectorAll("#board thead th"))
          .slice(1) // Escludi la prima cella vuota
          .map(th => th.innerText.trim());
      const rows = Array.from(document.querySelectorAll("#board tbody tr")).map(tr => {
          const points = tr.cells[0].innerText.trim();
          const questions = Array.from(tr.cells)
              .slice(1) // Escludi la colonna dei punti
              .map(td => {
                  const button = td.querySelector("button");
                  return {
                      text: button.textContent || "",
                      question: button.getAttribute("data-question") || "",
                      answer: button.getAttribute("data-answer") || ""
                  };
              });
          return { points, questions };
      });
      const boardData = {
          name: boardName,
          categories,
          rows
      };
      const blob = new Blob([JSON.stringify(boardData, null, 2)], { type: "application/json" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = boardName.replace(/\s+/g, "_") + ".json";
      link.click();
    }  
    // Funzione per scaricare il JSON
    function scaricaJSON(tabellone) {
        let jsonBlob = new Blob([JSON.stringify(tabellone, null, 2)], { type: "application/json" });
        let link = document.createElement("a");
        link.href = URL.createObjectURL(jsonBlob);
        link.download = tabellone.name + ".json";
        link.click();
    }
    /////////////////////////
    document.getElementById('saveBoard').addEventListener('click', salvaTabellone);
    /////////////////////////
    // Aggiungi un listener per il bottone di ritorno alla home
    document.getElementById('backToHomeButton').addEventListener('click', function(event) {
        // Se ci sono modifiche non salvate, chiedi conferma prima di andare alla home
        if (isBoardModified()) {
            const isConfirmed = confirm("Le modifiche non salvate andranno perse. Sei sicuro di voler tornare alla home?");
            if (!isConfirmed) {
                // Cancella il link se l'utente non conferma
                event.preventDefault();
            }
        }
    });
    /////////////////////////
    // Funzione per rilevare se il tabellone è stato modificato
    function isBoardModified() {
        // Verifica se ci sono modifiche nel tabellone (ad esempio controllando se qualche cella è modificata)
        // Puoi implementare un controllo in base a come vengono gestiti i dati (modifiche alle celle, ai titoli, etc.)
        const modifiedCells = document.querySelectorAll('[contenteditable="true"]');
        for (let cell of modifiedCells) {
            if (cell.innerText.trim() !== "") {
                return true; // Se ci sono celle modificate
            }
        }
        return false; // Se non ci sono modifiche
    }
    /////////////////////////
    // Gestione del caso in cui l'utente tenta di lasciare la pagina
    /*window.addEventListener('beforeunload', function(event) {
        if (isBoardModified()) {
            // Mostra il messaggio di conferma se l'utente cerca di navigare lontano dalla pagina
            const message = "Le modifiche non salvate andranno perse. Sei sicuro di voler lasciare questa pagina?";
            event.returnValue = message; // Mostra il popup di conferma
            return message; // Alcuni browser richiedono di restituire il messaggio
        }
    });*/
    /////////////////////////
    // Associa l'evento a tutti i bottoni già presenti
    document.querySelectorAll('.btn-question').forEach(attachQuestionEvent);
  </script>
</body>
</html>
